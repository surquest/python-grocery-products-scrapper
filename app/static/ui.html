<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scraper Interface</title>
    <style>
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-bg: #f8f9fa;
            --color-card-bg: #fff;
            --color-border: #dee2e6;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-bg);
            color: #343a40;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #212529;
            font-size: 2.5em;
        }

        /* --- Controls & Status --- */
        #controls-section {
            background: var(--color-card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-subtle);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #product-input {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
            font-size: 1em;
        }

        #button-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
            box-shadow: var(--shadow-subtle);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none; /* Controlled by JS */
        }
        .loading .spinner { display: block; }
        .loading.btn-primary { padding-left: 10px; padding-right: 15px; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #status-message {
            min-height: 20px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
            display: none; /* Initially hidden */
        }

        .status-error {
            background-color: #f8d7da;
            color: var(--color-error);
            border: 1px solid var(--color-error);
            display: block;
        }

        .status-success {
            background-color: #d4edda;
            color: var(--color-success);
            border: 1px solid var(--color-success);
            display: block;
        }

        .status-info {
            background-color: #cfe2ff;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            display: block;
        }

        /* --- Results Grid --- */
        #results-container {
            margin-top: 30px;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr; /* Default: 1 column */
        }

        /* Tablet Layout */
        @media (min-width: 600px) {
            #results-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Desktop Layout (3-4 columns) */
        @media (min-width: 1000px) {
            #results-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1400px) {
            #results-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* --- Card Styling --- */
        .product-card {
            background: var(--color-card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-subtle);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card-image-container {
            /* height: 150px; */
            margin-bottom: 15px;
            overflow: hidden;
            border-radius: 4px;
            background-color: var(--color-bg);
        }

        .card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fit square area */
            display: block;
        }

        .card-title {
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .card-brand {
            font-size: 0.9em;
            color: var(--color-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .card-price {
            font-size: 1.5em;
            color: var(--color-error); /* Use red for price emphasis */
            font-weight: 700;
            margin-bottom: 10px;
        }

        .card-description {
            font-size: 0.95em;
            color: #495057;
            margin-bottom: 10px;
            flex-grow: 1; /* Push metadata to the bottom */
        }

        .card-metadata {
            font-size: 0.8em;
            color: #888;
            border-top: 1px dashed var(--color-border);
            padding-top: 10px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    
    <main aria-live="polite" aria-busy="false" id="main-content">
        <section id="controls-section">
            <label for="product-input">Product IDs</label>
            <textarea
                id="product-input"
                aria-label="Paste product IDs - one per line"
                placeholder="Paste product IDs - one per line. Example:&#10;130296010&#10;209255932"
            >130296010&#10;209255932</textarea>

            <div id="button-container">
                <button id="clear-btn" class="btn-secondary">Clear</button>
                <button id="scrape-btn" class="btn-primary">
                    <span class="spinner"></span>
                    Scrape
                </button>
            </div>

            <div id="status-message" role="alert"></div>
        </section>

        <section id="results-section">
            <div id="results-container">
                <!-- Product cards will be injected here -->
            </div>
        </section>
    </main>

    <script>
        // --- Configuration & Mock Data ---
        const MOCK_MODE = false; //true; // Set to true to bypass fetch and use mock data.
        const API_ENDPOINT = '/products:scrape';
        const DEFAULT_IMAGE_URL = 'https://via.placeholder.com/300x300?text=Product+Image'; // Placeholder for default/missing image

        // Define Currency
        const CURRENCY = 'Kƒç'; // Used for formatting price

        // Fallback SVG data URL for broken images (simple broken link icon)
        const FALLBACK_IMAGE_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIgZmlsbD0iI2NjYyI+PC9yZWN0PjxsaW5lIHgxPSI2IiB5MT0iMTgiIHgyPSIxOCIgeTI9IjYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIj48L2xpbmU+PC9zdmc+';

        // Sample Data structure used for MOCK_MODE
        const MOCK_RESPONSE = [
            {
                id: "7890123",
                tpnb: "A1B2C3D4",
                title: "Premium Sparkling Water, Lemon & Lime Flavour",
                brandName: "Aqua Zest",
                price: 38.90,
                description: ["A refreshing and crisp sparkling water perfect for summer refreshment. Naturally flavored with real fruit extracts. Low calorie and zero sugar."],
                imageUrl: DEFAULT_IMAGE_URL,
                superDepartmentName: "Beverages",
                departmentName: "Soft Drinks",
                shelfName: "Flavored Water"
            },
            {
                id: "3456789",
                tpnb: "E5F6G7H8",
                title: "Dark Roast Coffee Beans, Single Origin Ethiopia",
                brandName: "Bean Enthusiast",
                price: 199.50,
                description: ["Rich, dark roast with notes of chocolate and caramel. Sustainably sourced from high-altitude Ethiopian farms. Best consumed within 3 months of opening."],
                imageUrl: 'https://images.unsplash.com/photo-1517404215738-15263e9f4a54?w=300&h=300&fit=crop&q=80', // Simulate a real image
                superDepartmentName: "Pantry",
                departmentName: "Hot Drinks",
                shelfName: "Coffee"
            },
            {
                id: "101112",
                tpnb: "I9J0K1L2",
                title: "Organic Whole Wheat Bread Loaf (Missing Image Test)",
                brandName: "Bakers Delight",
                price: 45.00,
                description: ["A hearty whole wheat loaf baked fresh daily. Great source of fiber. This description is intentionally very long to test truncation functionality. The quick brown fox jumps over the lazy dog and then takes a nap under the sun."],
                imageUrl: 'http://nonexistent-url.com/image.jpg', // Simulate a broken image
                superDepartmentName: "Bakery",
                departmentName: "Bread",
                shelfName: "Loaves"
            },
        ];

        // --- DOM Elements ---
        const inputEl = document.getElementById('product-input');
        const scrapeBtn = document.getElementById('scrape-btn');
        const clearBtn = document.getElementById('clear-btn');
        const statusEl = document.getElementById('status-message');
        const resultsContainer = document.getElementById('results-container');
        const mainContent = document.getElementById('main-content');

        // --- State and Cache ---
        let productCache = {}; // Simple client-side cache

        // --- Utility Functions ---

        /** Truncates text and appends '...' if it exceeds maxLength. */
        function truncateText(text, maxLength = 120) {
            if (text.length > maxLength) {
                return text.substring(0, maxLength) + '...';
            }
            return text;
        }

        /** Sets the status message for the user. */
        function setStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
        }

        /** Clears the status message. */
        function clearStatus() {
            statusEl.textContent = '';
            statusEl.className = '';
            statusEl.style.display = 'none';
        }

        /** Handles loading state UI updates. */
        function setLoading(isLoading) {
            scrapeBtn.disabled = isLoading;
            clearBtn.disabled = isLoading;
            scrapeBtn.classList.toggle('loading', isLoading);
            mainContent.setAttribute('aria-busy', isLoading);
        }

        /** Processes textarea input into a clean array of strings. */
        function processInput(rawText) {
            return rawText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }

        // --- Card Rendering ---

        /** Creates a single product card element. */
        function createCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.tabIndex = 0; // Optional: Make cards focusable

            // Helper to safely get nested metadata
            const getMetadata = (p) => {
                const parts = [p.superDepartmentName, p.departmentName, p.shelfName].filter(Boolean);
                return parts.join(' ‚Ä∫ ');
            };

            // Image handling (Lazy loading and fallback)
            const imgContainer = document.createElement('div');
            imgContainer.className = 'card-image-container';

            const img = document.createElement('img');
            img.src = product.defaultImageUrl || DEFAULT_IMAGE_URL;
            img.alt = `Image of ${product.title} from ${product.brandName}`;
            img.loading = 'lazy'; // Lazy loading
            img.onerror = function() {
                // Replace broken image with SVG fallback
                this.onerror = null; // Prevent infinite loop
                this.src = FALLBACK_IMAGE_SVG;
                this.alt = 'Image not available';
            };
            imgContainer.appendChild(img);

            // Title
            const titleEl = document.createElement('h3');
            titleEl.className = 'card-title';
            titleEl.textContent = product.title;

            // Brand
            const brandEl = document.createElement('p');
            brandEl.className = 'card-brand';
            brandEl.textContent = product.brandName;

            // Price (Using specified CURRENCY)
            const priceEl = document.createElement('p');
            priceEl.className = 'card-price';
            priceEl.textContent = `${product.price.toFixed(2)} ${CURRENCY}`; // Price formatting

            // Description (Truncated, uses first element if description is an array)
            const descriptionText = Array.isArray(product.description) && product.description.length > 0
                ? product.description[0]
                : 'No description provided.';
            const descEl = document.createElement('p');
            descEl.className = 'card-description';
            descEl.textContent = truncateText(descriptionText); // Sanitize and truncate

            // Metadata
            const metadataEl = document.createElement('p');
            metadataEl.className = 'card-metadata';
            metadataEl.textContent = getMetadata(product);

            card.append(imgContainer, titleEl, brandEl, priceEl, descEl, metadataEl);
            return card;
        }

        /** Renders the array of product objects into the results container. */
        function renderResults(products) {
            resultsContainer.innerHTML = ''; // Clear existing results

            if (!products || products.length === 0) {
                setStatus('No products found matching the input criteria.', 'info');
                return;
            }

            products.forEach(product => {
                const card = createCard(product);
                resultsContainer.appendChild(card);
            });

            setStatus(`Successfully loaded ${products.length} product(s).`, 'success');
        }

        // --- Main Event Handlers ---

        /** Handles the Scrape button click and API call logic. */
        async function handleScrape() {
            clearStatus();
            resultsContainer.innerHTML = '';
            setLoading(true);

            const lines = processInput(inputEl.value);
            const inputKey = lines.join('|');

            if (lines.length === 0) {
                setStatus('Please paste at least one product ID or name.', 'error');
                setLoading(false);
                return;
            }

            // 1. Client-Side Caching Check (Extra Feature)
            if (productCache[inputKey]) {
                console.log('Cache hit. Using cached results.');
                renderResults(productCache[inputKey]);
                setLoading(false);
                return;
            }

            try {
                let data;

                if (MOCK_MODE) {
                    console.warn('MOCK MODE ENABLED: Using sample data instead of fetching.');
                    // Simulate network delay for better UX testing
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    data = MOCK_RESPONSE.filter(p => lines.some(line => p.title.includes(line) || p.brandName.includes(line)));
                } else {
                    setStatus('Sending request...', 'info');

                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lines)
                    });

                    // Defensive parsing and error handling
                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({ message: `HTTP Error ${response.status}: Failed to parse error body.` }));
                        console.error('API Error:', errorBody);
                        throw new Error(errorBody.message || `Request failed with status ${response.status}`);
                    }

                    data = await response.json();
                    console.log('API Response (Success):', data);
                }

                // 2. Data Validation (Ensure response is an array)
                if (!Array.isArray(data["products"])) {
                    throw new Error('Invalid data format received from server. Expected an array.');
                }

                // 3. Render and Cache
                productCache[inputKey] = data;
                renderResults(data["products"]);

            } catch (error) {
                console.error('Scrape Operation Failed:', error);
                setStatus(`Error: ${error.message || 'A network error occurred.'}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        /** Clears the input field, results, and status area. */
        function handleClear() {
            inputEl.value = '';
            resultsContainer.innerHTML = '';
            clearStatus();
            mainContent.setAttribute('aria-busy', false);
        }

        // --- Event Listeners ---

        scrapeBtn.addEventListener('click', handleScrape);
        clearBtn.addEventListener('click', handleClear);

        // Keyboard Accessibility (Ctrl/Cmd + Enter)
        inputEl.addEventListener('keyup', (e) => {
            if ((e.key === 'Enter' && (e.ctrlKey || e.metaKey)) && !scrapeBtn.disabled) {
                handleScrape();
            }
        });

        // Ensure Enter key on the button triggers click
        scrapeBtn.addEventListener('keydown', (e) => {
             if (e.key === 'Enter' && !scrapeBtn.disabled) {
                e.preventDefault();
                handleScrape();
            }
        });

        // Initialize: Set status for MOCK mode if active
        document.addEventListener('DOMContentLoaded', () => {
            if (MOCK_MODE) {
                setStatus('Application running in MOCK MODE. API calls are simulated.', 'info');
            }
        });

    </script>
</body>
</html>